#include "sdk.h"

#define INDEX_BLACK      10
#define INDEX_WHITE      1
#define INDEX_PINK       2
#define INDEX_RED        3
#define INDEX_BLUE       4
#define INDEX_GREEN      5
#define INDEX_YELLOW     6
#define INDEX_CYAN       7
#define INDEX_GRAY       9
#define INDEX_DARKGREEN  0
#define RANDOM           rand()%9




// get vram address for character position
unsigned char *GetVramAddr(unsigned long x,unsigned long y);

// print a single character
void PutChar(unsigned long x,unsigned long y,unsigned long color,unsigned long bgcolor,unsigned char ch,char drawfg,char drawbg,char mag);

// print a string
void Print(unsigned long x,unsigned long y,unsigned long color,const char *str);

// x is in pixels rather than character cells
void PrintFine(unsigned long x,unsigned long y,unsigned long color,const char *str);

// clear video ram
void Fillvram(unsigned long color);

void WriteNibble(int x, int y, unsigned char val);

void WriteByte(int x, int y, unsigned char val);

void WriteDword(int x, int y, unsigned long val);

void WriteNibbleDummy(int x, int y, unsigned char val);

void WriteByteDummy(int x, int y, unsigned char val);

void WriteDwordDummy(int x, int y, unsigned long val);

void FillRect(RECT *xirect, unsigned long xicolour);

void MoveToEx(short x, short y);

void LineTo(short x, short y);

void changeBuffer();

void DebugValue(int y, char * label, unsigned long val);

void WriteDecimal(int x, int y, unsigned long val);

void initScreenAndCtrl();

void memcpy(char *dest, char *src, int size);

int strlen(char * xistr);

void createScreenshot();

void memdump();





unsigned long colours[11];

int color,i;

void InitGlobals()
{
	colours[10] = 0x00000000L;
 	colours[1] = 0x00FFFFFFL;
 	colours[2] = 0x00FF00FFL;
 	colours[3] = 0x000000FFL;
 	colours[4] = 0x00FF0000L;
 	colours[5] = 0x0000FF00L;
 	colours[6] = 0x0000FFFFL;
 	colours[7] = 0x00FFFF00L;
 	colours[8] = 0x00FFFF88L;
 	colours[9] = 0x00888888L;
 	colours[0] = 0x00008800L;

 	i=0;
 	color=INDEX_GRAY;
}

SceCtrlData gpaddata;

void ProcessKeys(unsigned long xikeys)
{
  if (xikeys & PSP_CTRL_UP || xikeys & PSP_CTRL_RIGHT) {
             if(color>=10) { color=0; }
             else { color++; }
  }
  if (xikeys & PSP_CTRL_DOWN || xikeys & PSP_CTRL_LEFT) {
             if(color<0) { color=10; }
             else { color--; }
  }
  if (xikeys & PSP_CTRL_HOME) // if home is pressed
  {
             for(i=0;i<278;i++) {
                                Fillvram(0x00FFFFFFL);
                                changeBuffer();                                        // flip screen to display what i just wrote
                                sceKernelDelayThread(1*1000);
             }
             changeBuffer();                                        // flip the buffer back to drawing mode for fade* functions
             fadeIn();                                              // fadeIn  -----|  Nice Cute
             fadeOut();                                             // fadeOut -----|    Effect
		   sceKernelExitGame();                             // exit
  }

  if (xikeys & PSP_CTRL_TRIANGLE) createScreenshot();
  if (xikeys & PSP_CTRL_CIRCLE) memdump();
}

typedef struct snoflake {
        int x,y,flake;
} snoflake;
snoflake snowflake[100];


void _start(unsigned long, unsigned long *) __attribute__ ((section (".text.start")));
void _start(unsigned long arglen, unsigned long *argp)
{

  sceKernelDcacheWritebackInvalidateAll();
  int a=0,sway=0;



  InitGlobals();

  initScreenAndCtrl();

  fadeIn();
  fadeOut();

  Print (22,15,colours[INDEX_GREEN]," - Hello World! -");
  changeBuffer();
  sceKernelDelayThread(2*1000*1000);
  changeBuffer();

  fadeIn();
  fadeOut();

  for (i = 0; i<100; i++) {
       snowflake[i].x = rand()%480;
       snowflake[i].y = rand()%272;
       snowflake[i].flake = rand()%3;
  }


  for(;;)
  {
     gpaddata.Buttons = 0;

     sceCtrlReadBufferPositive(&gpaddata,1);

     ProcessKeys(gpaddata.Buttons);

     Fillvram(colours[INDEX_BLACK]);

for (a = 0;a<100;a++) {
          sway = rand()%4;
          if (sway == 1 || sway == 2) {
             snowflake[a].x -= 1;
          }
          if (sway == 3 || sway == 4) {
             snowflake[a].x += 1;
          }
          snowflake[a].y += rand()%4;
          if (snowflake[a].y > 272) {
               snowflake[a].y = 0;
               snowflake[a].x = rand()%480;
          }
          if(snowflake[a].flake==0) {
                                 drawPixel(snowflake[a].x,snowflake[a].y,1,1,colours[color]);
          }
          if(snowflake[a].flake==1) {
                                    drawPixel(snowflake[a].x,snowflake[a].y,2,2,colours[color]);
          }
          if(snowflake[a].flake==2) {
                                    drawPixel(snowflake[a].x,snowflake[a].y,3,3,colours[color]);
          }
     }




     Print (0,0,colours[INDEX_WHITE],"PS Vita Hello World PoC for FW 3.15");
     Print (0,2,colours[INDEX_WHITE],"Exploit/SDK");
     Print (0,3,colours[INDEX_GREEN],"KanadeEngel");

     Print (0,5,colours[INDEX_WHITE],"Step! Step! Into catastrophe");
     Print (0,7,colours[INDEX_WHITE],"Up! Down! Final Battle! desu~ :3");
	 Print (0,10,colours[INDEX_WHITE],"Special thanks goes to qwikrazor87!");

     drawPixel(0,240,480,266,colours[INDEX_DARKGREEN]);





     changeBuffer();

  }

}
